<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>NanoStyle OpenAI Connectivity Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Chivo:wght@400;600;700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-ivory: #fffaf1;
        --bg-peach: #ffe4c8;
        --ink: #20201b;
        --ink-soft: #4f4f45;
        --card: #fffdf8;
        --line: #e3d8c7;
        --brand: #d64f2e;
        --brand-strong: #bb3b1f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Chivo', sans-serif;
        color: var(--ink);
        min-height: 100vh;
        background:
          radial-gradient(circle at 12% 10%, rgba(255, 196, 125, 0.4), transparent 38%),
          radial-gradient(circle at 90% 82%, rgba(214, 79, 46, 0.2), transparent 35%),
          linear-gradient(160deg, var(--bg-ivory), var(--bg-peach));
      }

      .shell {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
      }

      .hero {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.88), rgba(255, 255, 255, 0.66));
        padding: 1.2rem 1.25rem;
        margin-bottom: 1rem;
      }

      .kicker {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        color: var(--ink-soft);
        text-transform: uppercase;
      }

      h1 {
        margin: 0.35rem 0;
        font-family: 'Fraunces', serif;
        font-size: clamp(1.5rem, 3vw, 2.4rem);
      }

      .panel {
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 20px;
        padding: 1.25rem;
        box-shadow: 0 16px 36px -26px rgba(67, 39, 24, 0.4);
      }

      .stack {
        display: grid;
        gap: 0.9rem;
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.4rem;
      }

      textarea {
        width: 100%;
        border: 1px solid #cfc2ae;
        border-radius: 12px;
        padding: 0.8rem 0.85rem;
        font: inherit;
        color: var(--ink);
        background: #fff;
        min-height: 140px;
        resize: vertical;
      }

      textarea:focus,
      button:focus-visible {
        outline: 3px solid rgba(214, 79, 46, 0.35);
        outline-offset: 1px;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
      }

      button {
        border: 0;
        border-radius: 12px;
        padding: 0.72rem 1rem;
        font: inherit;
        font-weight: 600;
        cursor: pointer;
      }

      .primary {
        background: var(--brand);
        color: #fff;
      }

      .primary:hover {
        background: var(--brand-strong);
      }

      .ghost {
        background: #efe5d6;
        color: var(--ink);
      }

      .status {
        min-height: 1.4rem;
        font-size: 0.93rem;
      }

      .status[data-kind='error'] {
        color: #9b2d1b;
      }

      .status[data-kind='ok'] {
        color: #2f7e42;
      }

      .output-wrap {
        border: 1px dashed #d8c7ad;
        border-radius: 14px;
        padding: 0.9rem;
        background: #fffaf4;
      }

      .output-text {
        margin: 0;
        white-space: pre-wrap;
        line-height: 1.45;
      }

      .hint {
        color: var(--ink-soft);
        font-size: 0.86rem;
      }

      @media (max-width: 640px) {
        .shell {
          padding: 1rem 0.8rem 2rem;
        }
        .panel {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="hero">
        <div class="kicker">NanoStyle MVP</div>
        <h1 id="page-title" tabindex="-1">OpenAI Connectivity Test</h1>
        <p class="hint">Send text in, confirm text comes back from your OpenAI prompt config.</p>
      </section>

      <section class="panel">
        <div id="status" class="status" aria-live="polite"></div>
        <form id="app-form" class="stack" novalidate>
          <div>
            <label for="input-text">Input text</label>
            <textarea id="input-text" name="inputText" placeholder="Type any text and submit to test OpenAI connectivity."></textarea>
            <div class="hint">Ctrl/Cmd+Enter submits quickly.</div>
          </div>
          <div class="row">
            <button class="primary" type="submit" id="submit-btn">Send to OpenAI</button>
            <button class="ghost" type="button" id="clear-btn">Clear</button>
          </div>
        </form>

        <div id="output" class="output-wrap" hidden>
          <p id="output-text" class="output-text"></p>
          <div id="output-model" class="hint"></div>
        </div>
      </section>
    </main>

    <script type="module" is:inline>
      class FrontendApiError extends Error {
        constructor(message, code = 'INTERNAL_ERROR', retryable = false) {
          super(message);
          this.code = code;
          this.retryable = retryable;
        }
      }

      const state = {
        submitting: false,
        notice: '',
        error: '',
      };

      const els = {
        form: document.getElementById('app-form'),
        input: document.getElementById('input-text'),
        submit: document.getElementById('submit-btn'),
        clear: document.getElementById('clear-btn'),
        status: document.getElementById('status'),
        output: document.getElementById('output'),
        outputText: document.getElementById('output-text'),
        outputModel: document.getElementById('output-model'),
      };

      els.form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (state.submitting) return;

        clearStatus();
        const text = els.input.value.trim();
        if (text.length === 0) {
          setError('Please enter text first.');
          return;
        }

        state.submitting = true;
        render();
        try {
          const result = await request('/api/openai/test', {
            method: 'POST',
            body: JSON.stringify({ text }),
          });
          els.outputText.textContent = result.outputText;
          els.outputModel.textContent = `Model: ${result.model}`;
          els.output.hidden = false;
          state.notice = 'OpenAI response received.';
          state.error = '';
        } catch (error) {
          setError(toUserMessage(error, 'Request failed.'));
        } finally {
          state.submitting = false;
          render();
        }
      });

      els.clear.addEventListener('click', () => {
        els.input.value = '';
        els.output.hidden = true;
        els.outputText.textContent = '';
        els.outputModel.textContent = '';
        clearStatus();
        els.input.focus();
      });

      els.input.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
          event.preventDefault();
          els.form.requestSubmit();
        }
      });

      async function request(url, init) {
        const requestId = `ui_${crypto.randomUUID().replaceAll('-', '')}`;
        let response;
        try {
          response = await fetch(url, {
            ...init,
            headers: {
              ...(init.body ? { 'content-type': 'application/json' } : {}),
              'x-request-id': requestId,
              ...(init.headers || {}),
            },
          });
        } catch {
          throw new FrontendApiError('Network request failed. Please retry.', 'INTERNAL_ERROR', true);
        }

        const payload = await response.json().catch(() => null);
        if (payload?.ok === false) {
          throw new FrontendApiError(
            payload?.error?.message || 'Request failed.',
            payload?.error?.code || 'INTERNAL_ERROR',
            Boolean(payload?.error?.retryable),
          );
        }

        if (!response.ok || !payload || typeof payload.outputText !== 'string' || typeof payload.model !== 'string') {
          throw new FrontendApiError('Received an invalid server response. Please retry.', 'INTERNAL_ERROR', true);
        }
        return payload;
      }

      function render() {
        els.submit.disabled = state.submitting;
        els.submit.textContent = state.submitting ? 'Sending...' : 'Send to OpenAI';
        renderStatus();
      }

      function renderStatus() {
        if (state.error) {
          els.status.dataset.kind = 'error';
          els.status.textContent = state.error;
          return;
        }
        if (state.notice) {
          els.status.dataset.kind = 'ok';
          els.status.textContent = state.notice;
          return;
        }
        els.status.dataset.kind = '';
        els.status.textContent = '';
      }

      function toUserMessage(error, fallback) {
        if (error instanceof FrontendApiError) return error.message;
        if (error instanceof Error && error.message) return error.message;
        return fallback;
      }

      function setError(message) {
        state.error = message;
        state.notice = '';
        renderStatus();
      }

      function clearStatus() {
        state.error = '';
        state.notice = '';
        renderStatus();
      }
    </script>
  </body>
</html>
