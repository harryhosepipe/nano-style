<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>NanoStyle OpenAI Connectivity Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #090b10;
        --bg-soft: #10141d;
        --surface: #111826;
        --surface-2: #0d1421;
        --ink: #edf2ff;
        --ink-soft: #9aa4be;
        --line: #2a3449;
        --brand: #6ad6ff;
        --brand-strong: #4fb8f1;
        --ok: #70f4b0;
        --error: #ff7f8b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Space Grotesk', sans-serif;
        color: var(--ink);
        min-height: 100vh;
        background:
          radial-gradient(circle at 12% 16%, rgba(106, 214, 255, 0.2), transparent 30%),
          radial-gradient(circle at 86% 84%, rgba(72, 118, 255, 0.22), transparent 32%),
          linear-gradient(165deg, var(--bg), var(--bg-soft));
      }

      .shell {
        max-width: 860px;
        margin: 0 auto;
        padding: 2.4rem 1rem 4rem;
      }

      .hero {
        border: 1px solid var(--line);
        border-radius: 20px;
        background:
          linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent 60%),
          linear-gradient(130deg, rgba(106, 214, 255, 0.12), rgba(106, 214, 255, 0.03));
        padding: 1.35rem 1.45rem;
        margin-bottom: 1.1rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      .kicker {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.74rem;
        letter-spacing: 0.09em;
        color: var(--ink-soft);
        text-transform: uppercase;
      }

      h1 {
        margin: 0.45rem 0 0.5rem;
        font-size: clamp(1.5rem, 3.2vw, 2.45rem);
        line-height: 1.15;
      }

      .panel {
        border: 1px solid var(--line);
        background: linear-gradient(180deg, var(--surface), var(--surface-2));
        border-radius: 20px;
        padding: 1.3rem;
        box-shadow:
          0 20px 40px -30px rgba(0, 0, 0, 0.8),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }

      .stack {
        display: grid;
        gap: 0.9rem;
      }

      label {
        font-weight: 500;
        display: block;
        margin-bottom: 0.45rem;
      }

      textarea {
        width: 100%;
        border: 1px solid #34405a;
        border-radius: 12px;
        padding: 0.92rem 0.95rem;
        font: inherit;
        color: var(--ink);
        background: #0b111c;
        min-height: 170px;
        resize: vertical;
        line-height: 1.45;
      }

      textarea:focus,
      button:focus-visible {
        outline: 3px solid rgba(106, 214, 255, 0.35);
        outline-offset: 1px;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
      }

      button {
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 0.72rem 1.08rem;
        font: inherit;
        font-weight: 500;
        cursor: pointer;
      }

      .primary {
        background: linear-gradient(180deg, var(--brand), var(--brand-strong));
        color: #02131c;
        box-shadow: 0 10px 22px -16px rgba(106, 214, 255, 0.8);
      }

      .primary:hover {
        filter: brightness(1.06);
      }

      .ghost {
        background: #111b2e;
        color: #d8e4ff;
        border-color: #34405a;
      }

      .status {
        min-height: 1.4rem;
        font-size: 0.9rem;
      }

      .status[data-kind='error'] {
        color: var(--error);
      }

      .status[data-kind='ok'] {
        color: var(--ok);
      }

      .output-wrap {
        margin-top: 0.2rem;
        border: 1px solid #32425f;
        border-radius: 14px;
        padding: 1rem;
        background: #0a1220;
      }

      .output-text {
        margin: 0;
        white-space: pre-wrap;
        line-height: 1.5;
        overflow-wrap: anywhere;
      }

      .hint {
        color: var(--ink-soft);
        font-size: 0.84rem;
        font-family: 'IBM Plex Mono', monospace;
      }

      @media (max-width: 640px) {
        .shell {
          padding: 1rem 0.8rem 2rem;
        }
        .panel {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="hero">
        <div class="kicker">NanoStyle MVP</div>
        <h1 id="page-title" tabindex="-1">OpenAI Connectivity Test</h1>
        <p class="hint">Send text in, confirm text comes back from your OpenAI prompt config.</p>
      </section>

      <section class="panel">
        <div id="status" class="status" aria-live="polite"></div>
        <form id="app-form" class="stack" novalidate>
          <div>
            <label for="input-text">Input text</label>
            <textarea id="input-text" name="inputText" placeholder="Type any text and submit to test OpenAI connectivity."></textarea>
            <div class="hint">Ctrl/Cmd+Enter submits quickly.</div>
          </div>
          <div class="row">
            <button class="primary" type="submit" id="submit-btn">Send to OpenAI</button>
            <button class="ghost" type="button" id="clear-btn">Clear</button>
          </div>
        </form>

        <div id="output" class="output-wrap" hidden>
          <p id="output-text" class="output-text"></p>
          <div id="output-model" class="hint"></div>
        </div>
      </section>
    </main>

    <script type="module" is:inline>
      class FrontendApiError extends Error {
        constructor(message, code = 'INTERNAL_ERROR', retryable = false) {
          super(message);
          this.code = code;
          this.retryable = retryable;
        }
      }

      const state = {
        submitting: false,
        notice: '',
        error: '',
      };

      const els = {
        form: document.getElementById('app-form'),
        input: document.getElementById('input-text'),
        submit: document.getElementById('submit-btn'),
        clear: document.getElementById('clear-btn'),
        status: document.getElementById('status'),
        output: document.getElementById('output'),
        outputText: document.getElementById('output-text'),
        outputModel: document.getElementById('output-model'),
      };

      els.form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (state.submitting) return;

        clearStatus();
        const text = els.input.value.trim();
        if (text.length === 0) {
          setError('Please enter text first.');
          return;
        }

        state.submitting = true;
        render();
        try {
          const result = await request('/api/openai/test', {
            method: 'POST',
            body: JSON.stringify({ text }),
          });
          els.outputText.textContent = result.outputText;
          els.outputModel.textContent = `Model: ${result.model}`;
          els.output.hidden = false;
          state.notice = 'OpenAI response received.';
          state.error = '';
        } catch (error) {
          setError(toUserMessage(error, 'Request failed.'));
        } finally {
          state.submitting = false;
          render();
        }
      });

      els.clear.addEventListener('click', () => {
        els.input.value = '';
        els.output.hidden = true;
        els.outputText.textContent = '';
        els.outputModel.textContent = '';
        clearStatus();
        els.input.focus();
      });

      els.input.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
          event.preventDefault();
          els.form.requestSubmit();
        }
      });

      async function request(url, init) {
        const requestId = `ui_${crypto.randomUUID().replaceAll('-', '')}`;
        let response;
        try {
          response = await fetch(url, {
            ...init,
            headers: {
              ...(init.body ? { 'content-type': 'application/json' } : {}),
              'x-request-id': requestId,
              ...(init.headers || {}),
            },
          });
        } catch {
          throw new FrontendApiError('Network request failed. Please retry.', 'INTERNAL_ERROR', true);
        }

        const payload = await response.json().catch(() => null);
        if (payload?.ok === false) {
          throw new FrontendApiError(
            payload?.error?.message || 'Request failed.',
            payload?.error?.code || 'INTERNAL_ERROR',
            Boolean(payload?.error?.retryable),
          );
        }

        if (!response.ok || !payload || typeof payload.outputText !== 'string' || typeof payload.model !== 'string') {
          throw new FrontendApiError('Received an invalid server response. Please retry.', 'INTERNAL_ERROR', true);
        }
        return payload;
      }

      function render() {
        els.submit.disabled = state.submitting;
        els.submit.textContent = state.submitting ? 'Sending...' : 'Send to OpenAI';
        renderStatus();
      }

      function renderStatus() {
        if (state.error) {
          els.status.dataset.kind = 'error';
          els.status.textContent = state.error;
          return;
        }
        if (state.notice) {
          els.status.dataset.kind = 'ok';
          els.status.textContent = state.notice;
          return;
        }
        els.status.dataset.kind = '';
        els.status.textContent = '';
      }

      function toUserMessage(error, fallback) {
        if (error instanceof FrontendApiError) return error.message;
        if (error instanceof Error && error.message) return error.message;
        return fallback;
      }

      function setError(message) {
        state.error = message;
        state.notice = '';
        renderStatus();
      }

      function clearStatus() {
        state.error = '';
        state.notice = '';
        renderStatus();
      }
    </script>
  </body>
</html>
